# Sojmieblo

Интерактивное веб-приложение для цифрового «вандализма» и фана. Сервис позволяет загрузить любое фото и в реальном времени превратить лицо в «мятую резину» простым движением мыши.

## Описание

Sojmieblo - это веб-приложение, использующее WebGL и аппаратное ускорение для создания эффекта деформации изображений в реальном времени. Приложение позволяет пользователям загружать фотографии и применять к ним эффект "сжатия" (pinch effect), наводя курсор мыши на изображение.

## Техстек

- **Backend**: Node.js + Express
- **Frontend**: WebGL и библиотека glfx.js для мгновенной деформации сетки изображения (эффект Pinch)
- **Механика**: Аппаратное ускорение гарантирует плавный отклик 60 FPS
- **Безопасность**: Express Rate Limiter для защиты от злоупотреблений

## Требования

- Node.js версии 18 или выше (рекомендуется 20.x LTS)
- npm (Node Package Manager)
- Браузер с поддержкой WebGL (Chrome, Firefox, Safari, Edge последних версий)

## Установка

### Шаг 1: Клонирование репозитория

```bash
git clone https://github.com/Efidripy/sojmieblo.git
cd sojmieblo
```

### Шаг 2: Установка зависимостей

```bash
npm install
```

Эта команда установит следующие зависимости:
- `express` - веб-фреймворк для Node.js
- `express-rate-limit` - middleware для ограничения количества запросов

## Запуск

### Локальный запуск

```bash
npm start
```

Или используйте команду для режима разработки:

```bash
npm run dev
```

Приложение будет доступно по адресу: http://localhost:3000

### Запуск на другом порту

Вы можете указать порт через переменную окружения:

```bash
PORT=8080 npm start
```

### Автоматическая установка через shell скрипт (для Linux серверов)

Для автоматизированного развертывания на Linux сервере используйте скрипт `deploy_sojmieblo.sh`:

```bash
# Скачайте и запустите скрипт установки
wget https://raw.githubusercontent.com/Efidripy/sojmieblo/main/deploy_sojmieblo.sh
chmod +x deploy_sojmieblo.sh
sudo ./deploy_sojmieblo.sh
```

**Возможности скрипта:**

- ✅ Автоматическая проверка существующей установки
- ✅ Интерактивный выбор: переустановка, обновление или отмена
- ✅ Проверка версии Node.js (обновление при необходимости)
- ✅ Создание резервной копии при обновлении
- ✅ Маркер установки для предотвращения конфликтов

Скрипт автоматически:
- Клонирует репозиторий в `/var/www/sojmieblo`
- Установит Node.js 20.x LTS (современная поддерживаемая версия)
- Установит зависимости приложения (express, express-rate-limit)
- Настроит приложение для работы на порту 777
- Создаст systemd сервис для автозапуска
- Настроит Nginx как reverse proxy (потребуется ввести доменное имя)
- Запустит приложение

**Повторная установка:**

Если вы запустите скрипт повторно, вам будет предложено:
1. **Переустановить** - полное удаление и установка заново
2. **Обновить** - обновление кода и зависимостей (с резервной копией)
3. **Отменить** - прервать выполнение скрипта

После установки проверьте статус сервиса:
```bash
sudo systemctl status sojmieblo.service
```

**Обновление приложения:**

Для обновления уже установленного приложения запустите скрипт заново и выберите опцию "Обновить":

```bash
sudo ./deploy_sojmieblo.sh
# Выберите: 2) Обновить (обновить код из репозитория)
```

### Установка из release архива

Вы можете скачать готовый архив из раздела [Releases](https://github.com/Efidripy/sojmieblo/releases):

```bash
# Скачайте последний релиз
wget https://github.com/Efidripy/sojmieblo/releases/latest/download/sojmieblo-release.tar.gz

# Распакуйте архив
tar -xzf sojmieblo-release.tar.gz
cd sojmieblo

# Установите зависимости
npm install --production

# Запустите приложение
npm start
```

Архив содержит все необходимые файлы приложения, готовые к развертыванию.

## Использование

1. Откройте приложение в браузере
2. Загрузите фото (или перетащите его в область загрузки)
3. Наведите мышью на изображение для деформации лица в реальном времени
4. Нажмите на изображение для более сильного эффекта
5. Используйте кнопку "Сбросить" для возврата к оригиналу
6. Используйте кнопку "Новое фото" для загрузки другого изображения

## Архитектура приложения

### Серверная часть (server.js)

Приложение использует простой Express сервер со следующими функциями:

- **Статический файловый сервер**: Раздает файлы из директории `public/`
- **Rate Limiting**: Ограничивает количество запросов до 100 запросов с одного IP за 15 минут
- **Главный маршрут**: Обрабатывает GET запросы на корневой путь `/`

### Клиентская часть (public/)

#### Файлы:
- `index.html` - главная страница приложения
- `app.js` - основная логика приложения
- `glfx.js` - библиотека для WebGL эффектов
- `styles.css` - стили приложения

## Описание функций

### Серверные функции (server.js)

#### Настройка Rate Limiter
```javascript
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 минут
  max: 100, // Максимум 100 запросов с одного IP
  message: 'Слишком много запросов с вашего IP-адреса...'
});
```
**Описание**: Защищает сервер от злоупотреблений, ограничивая количество запросов.

#### Раздача статических файлов
```javascript
app.use(express.static(path.join(__dirname, 'public')));
```
**Описание**: Предоставляет доступ к файлам из директории `public/`.

### Клиентские функции (public/app.js)

#### `handleFileSelect(e)`
**Описание**: Обрабатывает выбор файла пользователем через input элемент.
- **Параметры**: `e` - событие изменения input элемента
- **Возвращает**: void
- **Использование**: Автоматически вызывается при выборе файла

#### `handleFile(file)`
**Описание**: Обрабатывает загруженный файл изображения, читает его и инициализирует canvas.
- **Параметры**: `file` - объект File с изображением
- **Возвращает**: void
- **Проверки**: Проверяет, что файл является изображением
- **Использование**: Вызывается после выбора или перетаскивания файла

#### `initializeCanvas(img)`
**Описание**: Инициализирует WebGL canvas с помощью библиотеки glfx.js и загружает изображение.
- **Параметры**: `img` - объект Image с загруженным изображением
- **Возвращает**: void
- **Особенности**: 
  - Создает glfx canvas
  - Масштабирует изображение до максимальных размеров 800x600 с сохранением пропорций
  - Загружает текстуру в WebGL
  - Настраивает обработчики событий мыши

#### `setupMouseInteraction()`
**Описание**: Настраивает взаимодействие с мышью для деформации изображения в реальном времени.
- **Параметры**: нет
- **Возвращает**: void
- **События**:
  - `mousemove` - применяет легкую деформацию при движении курсора
  - `mousedown` - применяет сильную деформацию при клике
  - `mouseup` - прекращает режим клика
  - `mouseleave` - сбрасывает изображение при выходе курсора

#### `applyDeformation(x, y, isClick)`
**Описание**: Применяет эффект деформации (bulge/pinch) к изображению.
- **Параметры**: 
  - `x` - координата X точки деформации
  - `y` - координата Y точки деформации
  - `isClick` - boolean, указывает на силу эффекта (true для клика)
- **Возвращает**: void
- **Параметры эффекта**:
  - Радиус: 20% от минимального размера canvas
  - Сила: -0.5 для наведения, -0.8 для клика (отрицательные значения создают эффект сжатия)

#### `resetImage()`
**Описание**: Сбрасывает изображение в исходное состояние без деформаций.
- **Параметры**: нет
- **Возвращает**: void
- **Использование**: Вызывается при нажатии кнопки "Сбросить" или при выходе курсора за пределы canvas

### WebGL эффекты (glfx.js)

#### `bulgePinch(x, y, radius, strength)`
**Описание**: Применяет эффект выпуклости (bulge) или сжатия (pinch) к изображению.
- **Параметры**:
  - `x` - координата X центра эффекта
  - `y` - координата Y центра эффекта
  - `radius` - радиус области воздействия в пикселях
  - `strength` - сила эффекта (-1 до 1, отрицательные значения для сжатия, положительные для выпуклости)
- **Возвращает**: canvas объект для цепочки вызовов
- **Использование**: Вызывается в методе `applyDeformation()`

## Переменные окружения

| Переменная | Описание | Значение по умолчанию |
|-----------|----------|---------------------|
| `PORT` | Порт для запуска сервера | 3000 |

Пример использования:
```bash
PORT=8080 npm start
```

## Технические детали

### Поддержка Drag & Drop
Приложение поддерживает перетаскивание файлов (Drag & Drop) для удобной загрузки изображений. Реализовано через обработчики событий `dragover`, `dragleave` и `drop`.

### Производительность
- Использование WebGL обеспечивает аппаратное ускорение
- Эффекты работают на GPU, обеспечивая 60 FPS
- Изображения автоматически масштабируются до разумных размеров (максимум 800x600)

### Безопасность
- Rate Limiting защищает от DDoS атак и злоупотреблений
- Проверка типа файла на стороне клиента
- Статический файловый сервер без выполнения пользовательского кода

## Устранение неполадок

### WebGL не поддерживается
Если вы видите ошибку "WebGL не поддерживается", попробуйте:
1. Обновить браузер до последней версии
2. Включить WebGL в настройках браузера
3. Обновить драйверы видеокарты

### Изображение не загружается
Убедитесь, что:
1. Файл является изображением (jpg, png, gif, и т.д.)
2. Размер файла не слишком большой (рекомендуется до 5 МБ)
3. Браузер имеет доступ к файловой системе

## Разработка

### Структура проекта
```
sojmieblo/
├── public/           # Статические файлы
│   ├── index.html   # Главная страница
│   ├── app.js       # Основная логика
│   ├── glfx.js      # Библиотека WebGL эффектов
│   └── styles.css   # Стили
├── server.js        # Express сервер
├── package.json     # Зависимости и скрипты
└── README.md        # Документация
```

### Добавление новых эффектов
Для добавления новых эффектов деформации используйте методы библиотеки glfx.js:
- `bulgePinch(x, y, radius, strength)` - выпуклость/сжатие
- `swirl(x, y, radius, angle)` - закручивание
- `perspective(before, after)` - перспектива
- И другие (см. документацию glfx.js)

## Лицензия

MIT

## Язык

Интерфейс приложения на русском языке, так как оно предназначено для русскоязычной аудитории.

## Контрибьюторам

Мы приветствуем вклад в развитие проекта! Если вы хотите добавить новые функции или исправить ошибки:
1. Форкните репозиторий
2. Создайте ветку для вашей функции (`git checkout -b feature/AmazingFeature`)
3. Закоммитите изменения (`git commit -m 'Add some AmazingFeature'`)
4. Запушьте в ветку (`git push origin feature/AmazingFeature`)
5. Откройте Pull Request